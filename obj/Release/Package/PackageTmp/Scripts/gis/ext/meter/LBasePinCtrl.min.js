var LBasePinCtrl=function(n,t){var i,r,u;this.mainctrl=n;this.map=n.settings.map;this.settings=n.settings;this.pinctrlid=n.settings.layerid+"_"+(new Date).getTime();this.graphics=[];this.isShowLabel=!1;this.isShowPin=!1;this.markerClusterGroup=null;i=this;this.settings.cluster&&!L.markerClusterGroup?helper.misc.getJavaScripts($.AppConfigOptions.script.gispath+"/leaflet/leaflet.markercluster.js",function(){t()}):setTimeout(function(){t()},1e3);this.map.on("zoomend",function(){var n=i.zoomPinsize();if(r&&clearTimeout(r),r=setTimeout(function(){$.each(i.graphics,function(){this.options.icon.options.iconSize=[n.x,n.y];this.options.icon.options.iconAnchor=[n.x/2-n.offsetx,n.y/2+n.offsety];this.options.icon.options.popupAnchor=[n.offsetx,-(n.y/2+n.offsety+2)];this.options.icon.options.tooltipAnchor=[0,-30];this.options.icon.options.glyphSize&&(this.options.icon.options.glyphSize=Math.floor(n.x*2/5)+"px",this.options.icon.options.glyphAnchor=[0,-Math.floor(n.x/5)]);this.setIcon(this.options.icon);this.getTooltip()&&this.isTooltipOpen()&&(this.getTooltip().getElement().style.marginTop=-(this.options.icon.options.iconAnchor[1]-2)+"px")});i.show(i.isShowPin);i.showLabel(i.isShowLabel)},100),i.onMapZoomEnd)i.onMapZoomEnd(i.map.getZoom())});this.map.on("moveend",function(){u&&clearTimeout(u);u=setTimeout(function(){i.show(i.isShowPin);i.showLabel(i.isShowLabel)},300)});return this};window.pinLeafletMaxZIndex||(window.pinLeafletMaxZIndex=1e4);LBasePinCtrl.prototype.reDraw=function(n){var t=this,u,r,i;this.settings.cluster&&this._createMarkerCluster();$.each(t.graphics,function(n,t){t.remove()});t.graphics=[];u=this.isShowLabel;r=0;n.length!==0&&(i=t.zoomPinsize(),$.each(n,function(){var e,f,u;pinLeafletMaxZIndex++;e=this;try{if(this.Y==undefined||this.X==undefined){console.log("無座標資料:"+JSON.stringify(this));return}if(f=t.settings.checkDataStatus.call(t.mainctrl,this),!f){console.log("checkDataStatus查無對應icon:"+JSON.stringify(this));return}this.rindex=r++;u=$.extend({className:f?"icon_"+f.classes:"",iconUrl:helper.misc.getAbsoluteUrl(f.url),iconSize:[i.x,i.y],iconAnchor:[i.x/2-i.offsetx,i.y/2+i.offsety],popupAnchor:[i.offsetx,-(i.y/2+i.offsety+2)],tooltipAnchor:[0,-30]},f);u.glyph&&(u.glyphSize=Math.floor(i.x*2/5)+"px",u.glyphAnchor=[0,-Math.floor(i.x/5)]);var o=$.extend({},t.settings.geometryOtherOptions,{icon:L.icon.glyph&&u.prefix&&u.glyph?L.icon.glyph(u):L.icon(u),opacity:.9,flag:t.settings.stTitle.call(t.mainctrl,e)}),n=L.marker([this.Y,this.X],o),s=JSON.stringify(o);if(t.graphics.push(n),t.settings.clickable){n.on("mouseover",function(){t.onFocusGraphic(n)});n.on("mouseout",function(){t.offFocusGraphic(n)});n.on("click",function(){t.settings.useInfoWindow&&t.showInfoWindow(n,!1);t.pinClick&&t.pinClick(e)})}n.pinctrlid=t.pinctrlid;n.rindex=e.rindex=this.rindex;n.pinsize=t.settings.pinsize;n.attributes=e;n.pinstatus=f;t.markerClusterGroup&&t.markerClusterGroup.addLayer(n)}catch(h){console.log("資料錯誤!!"+JSON.stringify(e))}}),this.isShowLabel&&this.showLabel(this.isShowLabel))};LBasePinCtrl.prototype.getCurrentZoomlevel=function(){return this.map.getZoom()};LBasePinCtrl.prototype.showInfoWindow=function(n,t){var r=this,o,h,i,s,e,u;if(!n.isPopupOpen()){if(t&&this.map.panTo(n.getLatLng()),this.markerClusterGroup&&this.markerClusterGroup.hasLayer(n)&&!n._map){this.markerClusterGroup.removeLayer(n);n.once("popupclose",function(){r.displayPin(n,!1);r.markerClusterGroup.addLayer(n)})}this.displayPin(n,!0);o="";this.settings.canFullInfowindow&&(o="<div class='zoom-in-ctrl'><span class=' glyphicon glyphicon-zoom-in'><\/div>");h=n.unbindPopup().bindPopup(o+'<div class="leaflet-infowindow-title '+n.pinstatus.classes+'">'+n.options.flag+"<\/div>"+this.settings.pinInfoContent.call(this.mainctrl,n.attributes,this.settings.infoFields),$.extend({closeOnClick:this.settings.singleInfoWindow,autoClose:this.settings.singleInfoWindow,className:"leaflet-infowindow",minWidth:250},typeof this.settings.useInfoWindow=="object"?this.settings.useInfoWindow:{})).openPopup().getPopup();i=$(h.getElement()).addClass("infowindow-"+this.settings.name);this.mainctrl.settings.infoWindowAnimation&&(s=i[0].style.transform,i[0].style.transform=s+" scale(.3)",i.addClass("leaflet-infow-animation"),requestAnimationFrame(function(){i.one("transitionend oTransitionEnd otransitionend MSTransitionEnd",function(){$(this).removeClass("leaflet-infow-animation showing")});i[0].style.transform=s+" scale(1)";i.addClass("showing")}));var f=window.getComputedStyle(i.find(".leaflet-infowindow-title")[0]),c=i.find(".leaflet-infowindow-title"),l=i.find(".leaflet-popup-close-button")[0],a=i.find(".leaflet-popup-content")[0];c.css("box-shadow",c.css("box-shadow").replace("#999",f.backgroundColor).replace("rgb(153, 153, 153)",f.backgroundColor));a.style.borderColor=l.style.borderColor=l.style.color=f.backgroundColor;i.find(".leaflet-popup-tip")[0].style.boxShadow=" 3px 3px 15px "+f.backgroundColor;u=i.find(".leaflet-popup-content");i.find(".zoom-in-ctrl").click(function(){u.toggleClass("full-zoom-in");u.hasClass("full-zoom-in")?(e=helper.jspanel.jspAlertMsg($(r.map.getContainer()),{autoclose:9999999,size:r.settings.canFullInfowindow==!0?undefined:r.settings.canFullInfowindow,classes:"modal-lg modal-dialog-full-window modal-dialog-"+r.settings.name+"-full-window"},function(){r.showInfoWindow(n,t)}),u.appendTo(e.find(".modal-content").empty())):(e.hide(),e.modal("hide"));r.mainctrl.$element.trigger($.BasePinCtrl.eventKeys.fullInfowindowChange,[u[0],u.hasClass("full-zoom-in")])})}};LBasePinCtrl.prototype.closeInfoWindow=function(n){n&&n.closePopup()};LBasePinCtrl.prototype.showLabel=function(n){var t,i;this.isShowLabel=n;t=this;this.graphics.length>0&&(i=this.map.getBounds(),$.each(this.graphics,function(){t._showOneLabel(this,n&&i.contains(this.getLatLng()))}))};LBasePinCtrl.prototype._showOneLabel=function(n,t){var r,i,u;n._map&&(t||this.isShowLabel)?(n.getTooltip()||n.bindTooltip('<div class="pin_label '+n.pinstatus.classes+'">'+n.options.flag+"<\/div>",{direction:"top",sticky:!0,permanent:!0,className:"leaflet-tooltip-label "}),r=n.pinstatus.classes.split(" "),i=$(n.getTooltip().getElement()).find("."+r[0]),i.length>0&&(u=window.getComputedStyle(i[0]),i[0].style.backgroundColor="transparent",i[0].style.color=u.fill,n.isTooltipOpen()||n.openTooltip(),n.getTooltip().getElement().style.marginTop=-(n.options.icon.options.iconAnchor[1]-2)+"px")):t||this.isShowLabel||n.unbindTooltip()};LBasePinCtrl.prototype.displayPin=function(n,t){t&&!n._map?n.addTo(this.map):t||n.remove()};LBasePinCtrl.prototype.show=function(n){if(this.isShowPin=n,this.markerClusterGroup)n?this.markerClusterGroup.addTo(this.map):this.markerClusterGroup.remove();else if(this.graphics.length>0){var t=this.map.getBounds(),i=this;$.each(this.graphics,function(){i.displayPin(this,n&&t.contains(this.getLatLng()))})}};LBasePinCtrl.prototype.getGraphicByRindex=function(n){var t;return $.each(this.graphics,function(){if(n==this.attributes.rindex)return t=this,!1}),t};LBasePinCtrl.prototype.offFocusGraphic=function(n,t){var r=this,i;if(n&&(i=this.zoomPinsize(n.pinsize),n.options.icon.options.iconSize=[i.x,i.y],n.setIcon(n.options.icon),n.setOpacity(.9),this.offFocusRowIndex&&!t&&this.offFocusRowIndex(n.attributes.rindex),this._showOneLabel(n,!1),this.markerClusterGroup&&!this.markerClusterGroup.hasLayer(n)))if(n.isPopupOpen())n.once("popupclose",function(){r.displayPin(n,!1);r.markerClusterGroup.addLayer(n)});else this.displayPin(n,!1),this.markerClusterGroup.addLayer(n)};LBasePinCtrl.prototype.onFocusRowIndex;LBasePinCtrl.prototype.offFocusRowIndex;LBasePinCtrl.prototype.onMapZoomEnd;LBasePinCtrl.prototype.click;LBasePinCtrl.prototype.onFocusGraphic=function(n,t){if(n){this.markerClusterGroup&&this.markerClusterGroup.hasLayer(n)&&!n._map&&(this.markerClusterGroup.removeLayer(n),this.displayPin(n,!0));var i=this.zoomPinsize(n.pinsize);if(n.options.icon.options.iconSize=[i.x*1.1,i.y*1.1],n.setIcon(n.options.icon),n.setOpacity(1),this.onFocusRowIndex&&!t)this.onFocusRowIndex(n.attributes.rindex);n.setZIndexOffset(window.pinLeafletMaxZIndex++);this._showOneLabel(n,!0)}};LBasePinCtrl.prototype.fitBounds=function(){this.map.fitBounds(L.featureGroup(this.graphics).getBounds())};LBasePinCtrl.prototype.zoomPinsize=function(n){var t=n?n:this.settings.pinsize,i,r,u,f;if(this.mainctrl.settings.dynPinsize){var e=t.step*t.x/t.y,i=t.x+(this.map.getZoom()-8)*e,r=t.y+(this.map.getZoom()-8)*t.step;i<t.minx&&(i=t.minx);i>t.maxx&&(i=t.maxx);r<t.miny&&(r=t.miny);r>t.maxy&&(r=t.maxy)}else i=t.x,r=t.y;return i=Math.floor(i),r=Math.floor(r),u=0,f=0,t.anchor&&t.anchor.indexOf("bottom")>=0&&(u=r/2),t.anchor&&t.anchor.indexOf("left")>=0&&(f=i/2),{x:i,y:r,offsetx:f,offsety:u}};LBasePinCtrl.prototype._createMarkerCluster=function(){var n=this;if(this.settings.cluster)if(L.markerClusterGroup||console.log("尚未引入https://unpkg.com/leaflet.markercluster@1.0.4/dist/leaflet.markercluster.js"),this.markerClusterGroup)this.markerClusterGroup.clearLayers();else{this.markerClusterGroup=L.markerClusterGroup({maxClusterRadius:this.settings.clusterRadius,iconCreateFunction:function(t){return n._defaultIconCreateFunction(n.markerClusterGroup,t)},disableClusteringAtZoom:this.settings.clusterDisableAtZoom?this.settings.clusterDisableAtZoom:20});this.markerClusterGroup.on("clustermouseover",function(t){var i=t.layer.getAllChildMarkers()[0];if(n.onFocusRowIndex)n.onFocusRowIndex(i.attributes.rindex);window.pinLeafleClusterZIndex=window.pinLeafleClusterZIndex||999;t.layer.getElement().style.zIndex=window.pinLeafleClusterZIndex++})}};LBasePinCtrl.prototype._defaultIconCreateFunction=function(n,t){return n._defaultIconCreateFunction(t)};